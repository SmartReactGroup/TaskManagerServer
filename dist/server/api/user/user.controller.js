"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _deleteProperty=require("babel-runtime/core-js/reflect/delete-property"),_deleteProperty2=_interopRequireDefault(_deleteProperty);exports.index=index,exports.create=create,exports.show=show,exports.destroy=destroy,exports.changePassword=changePassword,exports.upsert=upsert,exports.me=me,exports.authCallback=authCallback;var _user=require("./user.model"),_user2=_interopRequireDefault(_user),_environment=require("../../config/environment"),_environment2=_interopRequireDefault(_environment),_jsonwebtoken=require("jsonwebtoken"),_jsonwebtoken2=_interopRequireDefault(_jsonwebtoken);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function respondWithResult(e,t){return t=t||200,function(r){return r?e.status(t).json(r):null}}function validationError(e,t){return t=t||422,function(r){return e.status(t).json(r)}}function handleError(e,t){return t=t||500,function(r){return e.status(t).send(r)}}function index(e,t){return _user2.default.find({},"-salt -password").exec().then(function(e){t.status(200).json(e)}).catch(handleError(t))}function create(e,t){var r=new _user2.default(e.body);return r.provider="local",r.role="user",r.save().then(function(e){var r=_jsonwebtoken2.default.sign({_id:e._id},_environment2.default.secrets.session,{expiresIn:18e3});t.json({token:r})}).catch(validationError(t))}function show(e,t,r){var n=e.params.id;return _user2.default.findById(n).exec().then(function(e){if(!e)return t.status(404).end();t.json(e.profile)}).catch(function(e){return r(e)})}function destroy(e,t){return _user2.default.findByIdAndRemove(e.params.id).exec().then(function(){t.status(204).end()}).catch(handleError(t))}function changePassword(e,t){var r=e.user._id,n=String(e.body.oldPassword),s=String(e.body.newPassword);_user2.default.findById(r).exec().then(function(e){e.authenticate(n)?(e.password=s,e.save().then(function(){t.status(200).json({message:"Password changed successfully!!"})}).catch(validationError(t))):t.status(403).json({message:"Old password is not correct!"})})}function upsert(e,t){return e.body._id&&(0,_deleteProperty2.default)(e.body,"_id"),_user2.default.findOneAndUpdate({_id:e.params.id},e.body,{new:!0,upsert:!0,setDefaultsOnInsert:!0,runValidators:!0}).exec().then(respondWithResult(t)).catch(handleError(t))}function me(e,t,r){var n=e.user._id;return _user2.default.findOne({_id:n},"-salt -password").exec().then(function(e){return e?t.json(e):t.status(401).end()}).catch(function(e){return r(e)})}function authCallback(e,t){t.redirect("/")}