"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _crypto=require("crypto"),_crypto2=_interopRequireDefault(_crypto),_mongoose=require("mongoose"),_mongoose2=_interopRequireDefault(_mongoose),_user=require("./user.events");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}_mongoose2.default.Promise=require("bluebird");var UserSchema=new _mongoose.Schema({name:String,email:{type:String,lowercase:!0,required:!0},role:{type:String,default:"user"},password:{type:String,required:!0},provider:String,salt:String});UserSchema.virtual("profile").get(function(){return{name:this.name,role:this.role}}),UserSchema.virtual("token").get(function(){return{_id:this._id,role:this.role}}),UserSchema.path("email").validate(function(e){return e.length},"Email cannot be blank"),UserSchema.path("password").validate(function(e){return e.length},"Password cannot be blank"),UserSchema.path("email").validate(function(e){var r=this;return this.constructor.findOne({email:e}).exec().then(function(e){return!e||r.id===e.id}).catch(function(e){throw e})},"The specified email address is already in use.");var validatePresenceOf=function(e){return e&&e.length};UserSchema.pre("save",function(e){var r=this;return this.isModified("password")?validatePresenceOf(this.password)?void this.makeSalt(function(t,n){if(t)return e(t);r.salt=n,r.encryptPassword(r.password,function(t,n){return t?e(t):(r.password=n,e())})}):e(new Error("Invalid password")):e()}),UserSchema.methods={authenticate:function(e,r){var t=this;if(!r)return this.password===this.encryptPassword(e);this.encryptPassword(e,function(e,n){return e?r(e):t.password===n?r(null,!0):r(null,!1)})},makeSalt:function(){var e=void 0,r=void 0;if("function"==typeof(arguments.length<=0?void 0:arguments[0]))r=arguments.length<=0?void 0:arguments[0],e=16;else{if("function"!=typeof(arguments.length<=1?void 0:arguments[1]))throw new Error("Missing Callback");r=arguments.length<=1?void 0:arguments[1]}return e||(e=16),_crypto2.default.randomBytes(e,function(e,t){return e?r(e):r(null,t.toString("base64"))})},encryptPassword:function(e,r){if(!e||!this.salt)return r?r("Missing password or salt"):null;var t=new Buffer(this.salt,"base64");return r?_crypto2.default.pbkdf2(e,t,1e4,64,"sha256",function(e,t){return e?r(e):r(null,t.toString("base64"))}):_crypto2.default.pbkdf2Sync(e,t,1e4,64,"sha256").toString("base64")}},(0,_user.registerEvents)(UserSchema),exports.default=_mongoose2.default.model("User",UserSchema);