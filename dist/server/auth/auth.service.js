"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isAuthenticated=isAuthenticated,exports.hasRole=hasRole,exports.signToken=signToken,exports.setTokenCookie=setTokenCookie;var _environment=require("../config/environment"),_environment2=_interopRequireDefault(_environment),_jsonwebtoken=require("jsonwebtoken"),_jsonwebtoken2=_interopRequireDefault(_jsonwebtoken),_expressJwt=require("express-jwt"),_expressJwt2=_interopRequireDefault(_expressJwt),_composableMiddleware=require("composable-middleware"),_composableMiddleware2=_interopRequireDefault(_composableMiddleware),_user=require("../api/user/user.model"),_user2=_interopRequireDefault(_user);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var validateJwt=(0,_expressJwt2.default)({secret:_environment2.default.secrets.session});function isAuthenticated(){return(0,_composableMiddleware2.default)().use(function(e,r,t){e.query&&e.query.hasOwnProperty("access_token")&&(e.headers.authorization="Bearer "+e.query.access_token),e.query&&void 0===e.headers.authorization&&(e.headers.authorization="Bearer "+e.cookies.token),validateJwt(e,r,t)}).use(function(e,r,t){_user2.default.findById(e.user._id).exec().then(function(n){return n?(e.user=n,t(),null):r.status(401).end()}).catch(function(e){return t(e)})})}function hasRole(e){if(!e)throw new Error("Required role needs to be set");return(0,_composableMiddleware2.default)().use(isAuthenticated()).use(function(r,t,n){return _environment2.default.userRoles.indexOf(r.user.role)>=_environment2.default.userRoles.indexOf(e)?n():t.status(403).send("Forbidden")})}function signToken(e,r){return _jsonwebtoken2.default.sign({_id:e,role:r},_environment2.default.secrets.session,{expiresIn:18e3})}function setTokenCookie(e,r){if(!e.user)return r.status(404).send("It looks like you aren't logged in, please try again.");var t=signToken(e.user._id,e.user.role);r.cookie("token",t),r.redirect("/")}