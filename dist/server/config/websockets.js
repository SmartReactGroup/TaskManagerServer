"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify);exports.broadcast=broadcast,exports.default=initWebSocketServer;var _path=require("path"),_path2=_interopRequireDefault(_path),_primus=require("primus"),_primus2=_interopRequireDefault(_primus),_primusEmit=require("primus-emit"),_primusEmit2=_interopRequireDefault(_primusEmit);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var registerFunctions=[require("../api/thing/thing.socket").register];function onDisconnect(e){console.info("WebSocket from "+e.address.ip+":"+e.address.port+" disconnected")}function onConnect(e){console.info("WebSocket from "+e.address.ip+":"+e.address.port+" connected"),e.on("info",function(r){e.log((0,_stringify2.default)(r,null,2))});var r=!0,t=!1,i=void 0;try{for(var n,o=(0,_getIterator3.default)(registerFunctions);!(r=(n=o.next()).done);r=!0){(0,n.value)(e)}}catch(e){t=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(t)throw i}}}var primus=void 0;function broadcast(e){primus.forEach(function(r){r.emit("broadcast",e)})}function initWebSocketServer(e){return(primus=new _primus2.default(e,{transformer:"uws"})).plugin("emit",_primusEmit2.default),primus.on("connection",onConnect),primus.on("disconnection",onDisconnect),"development"===process.env.NODE_ENV?new _promise2.default(function(e,r){primus.save(_path2.default.join(__dirname,"../../client/components/socket/primus.js"),function(t){if(t)return r(t);e(primus)})}):_promise2.default.resolve(primus)}